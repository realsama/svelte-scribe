import t from"@markdoc/markdoc";import n from"fs";import r from"path";import e from"js-yaml";import{spawn as o}from"child_process";var a=function(){return a=Object.assign||function(t){for(var n,r=1,e=arguments.length;r<e;r++)for(var o in n=arguments[r])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t},a.apply(this,arguments)};function c(t,n,r,e){return new(r||(r=Promise))((function(o,a){function c(t){try{s(e.next(t))}catch(t){a(t)}}function i(t){try{s(e.throw(t))}catch(t){a(t)}}function s(t){var n;t.done?o(t.value):(n=t.value,n instanceof r?n:new r((function(t){t(n)}))).then(c,i)}s((e=e.apply(t,n||[])).next())}))}function i(t,n){var r,e,o,a,c={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function i(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;a&&(a=0,i[0]&&(c=0)),c;)try{if(r=1,e&&(o=2&i[0]?e.return:i[0]?e.throw||((o=e.return)&&o.call(e),0):e.next)&&!(o=o.call(e,i[1])).done)return o;switch(e=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,e=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(!(o=c.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){c=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){c.label=i[1];break}if(6===i[0]&&c.label<o[1]){c.label=o[1],o=i;break}if(o&&c.label<o[2]){c.label=o[2],c.ops.push(i);break}o[2]&&c.ops.pop(),c.trys.pop();continue}i=n.call(t,c)}catch(t){i=[6,t],e=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function s(t){var n="function"==typeof Symbol&&Symbol.iterator,r=n&&t[n],e=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&e>=t.length&&(t=void 0),{value:t&&t[e++],done:!t}}};throw new TypeError(n?"Object is not iterable.":"Symbol.iterator is not defined.")}function u(t,n){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var e,o,a=r.call(t),c=[];try{for(;(void 0===n||n-- >0)&&!(e=a.next()).done;)c.push(e.value)}catch(t){o={error:t}}finally{try{e&&!e.done&&(r=a.return)&&r.call(a)}finally{if(o)throw o.error}}return c}var l=function(t){return c(void 0,void 0,void 0,(function(){var e,o;return i(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),c=r.posix.resolve(t),e=c.split(r.sep).join(r.posix.sep),o=n.existsSync("".concat(e,".js"))||n.existsSync("".concat(e,".ts"))?e:"".concat(e,"/index"),[4,import("".concat(o,".js"))];case 1:return[2,a.sent().default];case 2:return a.sent(),[2,{}];case 3:return[2]}var c}))}))},f=function(t,e){return c(void 0,void 0,void 0,(function(){var o,c,s,u,f,d,p;return i(this,(function(i){switch(i.label){case 0:if(o=r.posix.resolve(t),!n.existsSync(o)&&"./markdoc"!==t)throw new Error("Can't find the schema at '".concat(o,"' from the passed option 'schema: ").concat(t));return[4,l("".concat(o,"/config"))];case 1:return c=i.sent(),[4,l("".concat(o,"/tags"))];case 2:return s=i.sent(),[4,l("".concat(o,"/nodes"))];case 3:return u=i.sent(),[4,l("".concat(o,"/functions"))];case 4:return f=i.sent(),[4,l("".concat(o,"/variables"))];case 5:return d=i.sent(),p=v("".concat(o,"/partials"),e),[2,a({tags:s,nodes:u,functions:f,variables:d,partials:p},c)]}}))}))},v=function(e,o){var a={};return n.readdirSync(e).forEach((function(c){var i=r.extname(c);if(o.includes(i)){var s=n.readFileSync(r.join(e,c),"utf8");a[c]=t.parse(s)}})),a},d=function(t){var e=new Map,o=function(t,a){void 0===a&&(a=!1),n.existsSync(t)&&n.readdirSync(t).forEach((function(c){var i=r.join(t,c);if(n.lstatSync(i).isDirectory())o(i,!0);else if(c.endsWith(".svelte")){var s=function(t,n,r){if(n){var e=u(r.split("/").slice(-2,-1),1)[0];return"index"===e?"Index":t==="".concat(e,".svelte")?"".concat(e[0].toUpperCase()).concat(e.slice(1)):null}var o=t.split(".svelte")[0];return"".concat(o[0].toUpperCase()).concat(o.slice(1))}(c,a,i);s&&e.set(s,i)}}))};return o(t),e},p=r.resolve(),y=r.join(p,"src","markdoc","components"),h=function(n){void 0===n&&(n={}),n.layout;var r=n.schema||"./markdoc",o=n.extensions||[".md"],a=n.components||y;return{markup:function(n){var l=n.content,v=void 0===l?"":l,p=n.filename,y=void 0===p?"":p;return c(void 0,void 0,void 0,(function(){var n,c,l,p,h,m,b,x;return i(this,(function(i){switch(i.label){case 0:return o.some((function(t){return y.endsWith(t)}))?[4,f(r,o)]:[2,null];case 1:return n=i.sent(),c=t.parse(v),l=function(t,n){var r,o=t.attributes.frontmatter?e.load(t.attributes.frontmatter):{},a=Object.assign((null===(r=null==n?void 0:n.variables)||void 0===r?void 0:r.markdoc)||{},{frontmatter:o}),c=Object.assign((null==n?void 0:n.variables)||{},{markdoc:a});return Object.assign(n,{variables:c})}(c,n),p=t.transform(c,l),h=d(a),m=function(t){var n,r,e="";try{for(var o=s(t),a=o.next();!a.done;a=o.next()){var c=u(a.value,2),i=c[0],l=c[1];e+="import ".concat(i," from '").concat(l,"';\n")}}catch(t){n={error:t}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return e}(h),b=function(t){var n,r,e="";try{for(var o=s(t),a=o.next();!a.done;a=o.next()){var c=u(a.value,1)[0];e+="[".concat(JSON.stringify(c),", ").concat(c,"],\n")}}catch(t){n={error:t}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return e}(h),x=p.children,[2,{code:"\n\t\t\t<script>\n\t\t\t\t".concat(m,'\n\t\t\t\timport Layout from "svelte-scribe/RenderLayout.svelte";\n\t\t\t\t\n\t\t\t\tconst components = new Map([').concat(b,"]);\n\n\t\t\t\tconst children = ").concat(JSON.stringify(x),";\n\t\t\t<\/script>\n\n\t\t\t<Layout {children} {components} />\n    \t\t"),data:{}}]}}))}))}}};function m(t){var n;return{name:"tsc",apply:"serve",buildStart:function(){(n=function(t,n){void 0===n&&(n="");return o("".concat(t," --pretty ").concat(n),[],{stdio:"inherit",shell:!0})}("npx tsc ".concat(t,"/*.ts --module esnext"),"--watch")).once("exit",(function(t){null!==t&&0!==t&&process.exit(t)}))},buildEnd:function(){n&&n.kill()}}}r.resolve();export{h as default,m as tscPlugin};
//# sourceMappingURL=main.mjs.map
